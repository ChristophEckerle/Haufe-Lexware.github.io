---
layout: post
title: Traefik
subtitle: Web server fitting nicely with docker
category: dev
tags: [traefik, docker, devops, development]
author: Christoph Eckerle, Philipp HÃ¶flin, Drilon Konjufka, Rainer Michel
author_email: rainer.michel@haufe-lexeware.com
header-img: "images/new/Exportiert_45.jpg"
---



1. Table of Contents
{:toc}

## Introduction

TODO: Describe how docker and Traefik cooperate

## Traefik for a multi-dev environment on a single host

### Use Case

We want to run several instances of an application and an ActiveMQ broker on a single virtual machine. Each application instance consists of a Tomcat server (Tomcat) and a database (MySQL). We want to assign different (sub-) domain names to the application server instances and to the web UI of ActiveMQ. Without Traefik we have to address the following problems:

* The application servers need different ports. The standard port :443 can only be used for one instance.
* A solution to map the different domain names is needed, e.g. configuring a DNS server.
* A web server needs to be installed to handle TLS as we do not want this handled by Tomcat

We found that these use cases could be addressed easily using Traefik.

![Overview of Development Environment]({{ site.baseurl }}/images/traefik/20180220-Traefik-logisch.png "Fig. 1: Overview of Development Environment")


### General Network Setup

The application instances are set up as docker containers that communicate over a default bridge network. You can find those networks as 10.01.0/24 and 10.0.2.0/24 depicted below. They allow communication between the Tomcat and the MySQL servers.

Both Tomcats provide their default port :8080 for HTTP(S) communication. Instead of exposing those ports directly we create a separate overlay network (10.0.0.0/24). Traefik uses this network to manage the traffic to the application servers. The same holds for ActiveMQ and its web UI that is provided on port :8161.

Traefik can be configured to provide access to all HTTP(S) endpoints through port :443 as a central access point for all clients and manage virtual hosts. The application servers become virtual hosts. Traefik routes HTTP requests to jms.mydomain.com:443 to activemq running on 10.0.0.64:8161 and those to 01-app.mydomain.com:443 to 10.0.0.46:8080 and so forth.

As you can expect from a web server acting as a web proxy, Traefik can terminate the TLS connection and pass the requests as HTTP requests to the application servers.

![Network Layout]({{ site.baseurl }}/images/traefik/20180220-Traefik-Network.png "Fig. 2: Network Layout")


### Configuration

We use docker swarm to set up the docker services. Traefik is configured by the following docker-compose file:
```yml
version: '3.4'

services:
  traefik:
    command: >
      --docker
      --docker.watch
      --docker.swarmmode
      --docker.domain=mydomain.com
      --docker.exposedbydefault=false
      --docker.trace
    networks:
      - frontend
    ports:
      - "443:443"
...
```

This section advices Traefik to manage access to the services running in network `frontend`.

This network has been set up as an overlay network:
```sh
docker network create --driver overlay traefik_ingress
```

We introduce a reference to this network as frontend in the docker-compose file for Traefik (and the services respectively):

```yml
networks:
  frontend:
    external:
      name: traefik_ingress
``` 

Traefik will automatically manage new services that connect to the frontend network. The sample docker-compose for the application server illustrates this:

```yml
services:
  app:
    networks:
      - frontend
      - backend
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.port=8080"
        - "traefik.docker.network=traefik_ingress"
        - "traefik.frontend.rule=Host: 01-app.mydomain.com"
```

We connect the application server to two networks: frontend and backend. Whereas backend is the bridge network automatically set up, frontend is again our overlay network `traefik_ingress`. We connect the application service `app` to Traefik using service labels:

traefik.enable | tell Traefik to manage access to this service
traefik.port   | the service is available on port 8080
traefik.docker.network | the managed network
traefik.frontend.rule  | the virtual host. All requests to this host are directed to the given service.  

And as a second example the docker-compose file for ActiveMQ:

```yml
services:
  activemq:
    networks:
      - frontend
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.port=8161"
        - "traefik.docker.network=traefik_ingress"
        - "traefik.frontend.rule=Host: jms.mydomain.com"

```
